name: Plugin release (GitHub)

on:
  workflow_call:
    inputs:
      plugin_slug:
        type: string
        required: false
        description: "Plugin slug for zip filename. Defaults to repository name."
      readme_path:
        type: string
        required: false
        default: "readme.md"
      version_heading_regex:
        type: string
        required: false
        default: "^###\\s+v?{VERSION}\\b.*$"
      tag_prefix:
        type: string
        required: false
        default: "v"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract release notes from README
        id: extract_notes
        shell: bash
        env:
          TAG: ${{ github.ref_name }}
          README_PATH: ${{ inputs.readme_path }}
          HEADING_RE: ${{ inputs.version_heading_regex }}
          TAG_PREFIX: ${{ inputs.tag_prefix }}
        run: |
          set -uo pipefail

          # Try case variations
          if [ -f "$README_PATH" ]; then
            ACTUAL_PATH="$README_PATH"
          elif [ -f "README.md" ]; then
            ACTUAL_PATH="README.md"
          elif [ -f "readme.md" ]; then
            ACTUAL_PATH="readme.md"
          else
            echo "::warning::No readme found (tried $README_PATH, README.md, readme.md) - using auto-generated notes"
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          export ACTUAL_README_PATH="$ACTUAL_PATH"

          python - <<'PY' || { echo "::warning::Failed to extract changelog - using auto-generated notes"; echo "has_notes=false" >> "$GITHUB_OUTPUT"; exit 0; }
          import os, re, sys, pathlib

          tag = os.environ["TAG"]
          prefix = os.environ.get("TAG_PREFIX", "v")
          ver = tag[len(prefix):] if tag.startswith(prefix) else tag
          readme_path = pathlib.Path(os.environ["ACTUAL_README_PATH"])
          heading_re = os.environ["HEADING_RE"].replace("{VERSION}", re.escape(ver))

          print(f"Tag: {tag}, Prefix: {prefix}, Version: {ver}")
          print(f"Heading regex: {heading_re}")

          text = readme_path.read_text(encoding="utf-8")

          # Find version heading, then collect lines until next ## heading
          lines = text.split('\n')
          heading_pat = re.compile(heading_re)
          found = False
          content_lines = []

          for line in lines:
            if not found:
              if heading_pat.match(line):
                found = True
                content_lines.append(line)
              continue
            # Stop at next heading (## or ###)
            if re.match(r'^##', line):
              break
            content_lines.append(line)

          if not found:
            print(f"WARNING: Could not find changelog heading for version {ver}", file=sys.stderr)
            sys.exit(1)

          notes = '\n'.join(content_lines).strip()

          if not notes:
            print(f"WARNING: Matched heading but content is empty", file=sys.stderr)
            sys.exit(1)

          out = pathlib.Path("release-notes.md")
          out.write_text(notes + "\n", encoding="utf-8")
          print(f"Wrote {out} ({len(notes)} chars)")
          PY

          echo "has_notes=true" >> "$GITHUB_OUTPUT"

      - name: Resolve plugin slug
        run: |
          if [ -n "${{ inputs.plugin_slug }}" ]; then
            echo "SLUG=${{ inputs.plugin_slug }}" >> "$GITHUB_ENV"
          else
            echo "SLUG=${{ github.event.repository.name }}" >> "$GITHUB_ENV"
          fi

      - name: Build plugin zip
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"
          PREFIX="${{ inputs.tag_prefix }}"
          VER="${TAG#${PREFIX}}"

          BUILD_DIR="${RUNNER_TEMP}/build"
          mkdir -p "$BUILD_DIR/${SLUG}"

          # Use .distignore if present, otherwise include everything
          if [ -f .distignore ]; then
            rsync -av --exclude-from=.distignore ./ "$BUILD_DIR/${SLUG}/"
          else
            rsync -av --exclude='.git' --exclude='.github' ./ "$BUILD_DIR/${SLUG}/"
          fi

          cd "$BUILD_DIR"
          zip -r "${GITHUB_WORKSPACE}/${SLUG}.zip" "${SLUG}"
          echo "Built ${SLUG}.zip"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: ${{ steps.extract_notes.outputs.has_notes == 'true' && 'release-notes.md' || '' }}
          generate_release_notes: true
          files: ${{ env.SLUG }}.zip