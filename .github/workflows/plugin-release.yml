name: Plugin release (GitHub)

on:
  workflow_call:
    inputs:
      readme_path:
        type: string
        required: false
        default: "readme.md"
      version_heading_regex:
        type: string
        required: false
        default: "^###\\s+{VERSION}\\b.*$"
      tag_prefix:
        type: string
        required: false
        default: "v"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract release notes from README
        shell: bash
        run: |
          set -euo pipefail

          TAG="${GITHUB_REF_NAME}"                 # e.g. v1.2.3
          PREFIX="${{ inputs.tag_prefix }}"
          VER="${TAG#${PREFIX}}"                   # e.g. 1.2.3

          README_PATH="${{ inputs.readme_path }}"
          if [ ! -f "$README_PATH" ]; then
            echo "Missing file: ${README_PATH}" >&2
            exit 1
          fi

          python - <<'PY'
          import os, re, sys, pathlib

          ver = os.environ["VER"]
          readme_path = pathlib.Path(os.environ["README_PATH"])
          heading_re = os.environ["HEADING_RE"].replace("{VERSION}", re.escape(ver))

          text = readme_path.read_text(encoding="utf-8")

          # find section under the version heading until next same-level heading
          pat = re.compile(rf"{heading_re}\n(.*?)(?=^\s*###\s+|\Z)", re.M | re.S)
          m = pat.search(text)

          if not m:
            print(f"Could not find changelog section for version {ver} in {readme_path}", file=sys.stderr)
            sys.exit(1)

          notes = m.group(1).strip()
          out = pathlib.Path("release-notes.md")
          out.write_text(notes + "\n", encoding="utf-8")
          print(f"Wrote {out} ({len(notes)} chars)")
          PY
        env:
          VER: ${{ github.ref_name }}
          README_PATH: ${{ inputs.readme_path }}
          HEADING_RE: ${{ inputs.version_heading_regex }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          body_path: release-notes.md
          generate_release_notes: true